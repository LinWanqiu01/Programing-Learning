> I/O 是计算机中的输入/输出操作（Input/Output），用于在计算机系统和外部设备之间进行数据交换。

![](/imgs/unbuffer IO.jpg)

​																		                                             文件I/O（如read，系统调用）

![](/imgs/buffer IO.jpg)

​                                                                                                                标准IO（如fread，库函数）

##### 01 文件I/O

文件I/O也被称为系统I/O，UNIX系统中的大多数文件I/O只需用到5个函数：open、read、write、lseek以及close。

文件I/O函数经常被称为**不带缓冲的I/O**（unbuffered I/O，与标准I/O函数相对照）。术语不带缓冲指的是每个read和write都是**系统调用**。**缓冲区可以减少I/O操作的次数，减少系统调用的开销，提高程序的性能。**

###### 1.1 文件描述符

在 UNIX 和类 UNIX 系统中，文件描述符是用于标识已打开文件的整数值。对于内核而言，所有打开的文件都通过文件描述符引用。文件描述符是一个非负整数。当打开一个现有文件或创建一个新文件时，内核向进程返回一个文件描述符。

[^晚秋]: 在符合POSIX.1的应用程序中，幻数0、1、2虽然已被标准化，但应当把它们替换成符号常量STDIN_FILENO、STDOUT_FILENO和STDERR_FILENO以提高可读性。这些常量都在头文件<unistd.h>中定义。

###### 1.2 函数ioclt

`ioctl`（Input/Output Control）函数是一个用于**设备 I/O 控制的系统调用**。它允许应用程序与设备驱动程序进行通信，通过发送特定的命令来控制和查询设备的状态和属性。

ioclt函数应用场景：

> 控制硬件设备的工作模式、配置和状态。
>
> 查询设备的信息，如设备 ID、版本号等。
>
> 进行设备的读写操作，如发送特定的数据或接收设备的数据。
>
> 控制设备的中断、定时器和 DMA 等特性。
>
> 修改设备的属性，如设置设备的速率、分辨率、缓冲区大小等。

man 2 ioclt显示结果：

![](/imgs/ioclt2.png)

![](/imgs/ioclt1.png)

###### 1.3 /dev/fd

`/dev/fd` 是一个特殊的目录，它提供了对已打开文件描述符的访问。打开文件/dev/fd/n等效于复制描述符n（假定描述符n是打开的）。

在 `/dev/fd` 目录下，文件描述符会以数字的形式作为文件名存在。例如，`/dev/fd/0` 表示标准输入（stdin），`/dev/fd/1` 表示标准输出（stdout），`/dev/fd/2` 表示标准错误输出（stderr）。

[^wanqiu]: 注意/dev/fd区别于/dev/fb0

![](/imgs/fd.png)

![](/imgs/fd1.png)



##### 02 标准I/O

###### 2.1 流和FILE对象

所有文件I/O函数都是围绕文件描述符的。当打开一个文件时，即返回一个文件描述符，然后该文件描述符就用于后续的I/O操作。而**对于标准I/O库，它们的操作是围绕流（stream）进行的**。当用标准I/O库打开或创建一个文件时，我们已**使一个流与一个文件相关联**。

[^wanqiu]: 请勿将标准I/O术语流与System V的STREAMS I/O系统相混淆，STREAMS I/O系统是System V的组成部分，Single UNIX Specification则将其标准化为XSI STREAMS选项，但是在SUSv4中已经将其标记为弃用

当打开一个流时，标准I/O函数fopen返回一个**指向FILE对象的指针**。该对象通常是一个结构，它包含了标准I/O库为管理该流需要的所有信息，包括用于实际I/O的文件描述符、指向用于该流缓冲区的指针、缓冲区的长度、当前在缓冲区中的字符数以及出错标志等。

###### 2.2 缓冲

标准I/O库提供缓冲的目的是尽可能减少使用read和write调用的次数。它也对每个I/O流自动地进行缓冲管理，从而避免了应用程序需要考虑这一点所带来的麻烦。

标准I/O提供三种类型的缓冲：全缓冲、行缓冲、不带缓冲。

[^wanqiu]: 标准错误流stderr通常是不带缓冲的，这就使得出错信息可以尽快显示出来，而不管它们是否含有一个换行符。

